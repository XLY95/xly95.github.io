let canvas,ctx,floatCanvas,floatCtx,startTime,bleDevice,gattServer,epdService,epdCharacteristic,msgIndex,appVersion,textDecoder,sourceImage=null,originalImage=null,originalCanvasData=null,currentParams={saturation:100,brightness:100,contrast:100,diffusion:50,ditherAlg:"floydSteinberg"},currentMode="image",canvasRotation=0,isDrawing=!1,lastX=0,lastY=0,currentTool="pen",brushSize=3,brushColor="#000000",imageScale=100,imageOffset={x:0,y:0},isDraggingImage=!1,dragStartPos={x:0,y:0},shiftKeyPressed=!1,imageRotation=0,isDrawingModeActive=!1,isDragging=!1,dragOffset={x:0,y:0},isResizing=!1;const EpdCmd={SET_PINS:170,INIT:169,CLEAR:168,SEND_CMD:167,SEND_DATA:166,REFRESH:165,SLEEP:164,SET_TIME:163,WEEK_START:162,WRITE_IMG:161,SET_CONFIG:160,SYS_RESET:171,SYS_SLEEP:172,CFG_ERASE:173,SET_MODE:174,EPD_CMD_J_H:255,EPD_CMD_N_Z:239,EPD_CMD_J_S:238,EPD_CMD_D_S:237,EPD_CMD_LED:236,EPD_CMD_MY:235,EPD_CMD_COLOR:234,EPD_CMD_4_MS:254,EPD_CMD_4_LED:253,EPD_CMD_4_XZ:252,EPD_CMD_4_ZF:251},DisplayMode={IMAGE:0,CLOCK:1,CALENDAR:2},canvasSizes=[{name:"2.13_122_250",width:122,height:250},{name:"4.2_400_300",width:400,height:300},{name:"7.5_800_480",width:800,height:480}],imageUpload=document.getElementById("imageFile"),previewCanvas=document.getElementById("previewCanvas"),floatPreviewCanvas=document.getElementById("floatPreviewCanvas"),noImagePlaceholder=document.getElementById("noImagePlaceholder"),processedImageInfo=document.getElementById("processedImageInfo"),btnProcess=document.getElementById("btnProcess"),btnSend=document.getElementById("btnSend"),btnDownload=document.getElementById("btnDownload"),btnReset=document.getElementById("btnReset"),btnClearLog=document.getElementById("btnClearLog"),btnBlackWhite=document.getElementById("btnBlackWhite"),btnBlackWhiteRed=document.getElementById("btnBlackWhiteRed"),ditherMode=document.getElementById("ditherMode"),ditherAlg=document.getElementById("ditherAlg"),logContainer=document.getElementById("logContainer"),statusContainer=document.getElementById("statusContainer"),floatingCanvasContainer=document.getElementById("floatingCanvasContainer"),toggleCanvasFloat=document.getElementById("toggleCanvasFloat"),closeCanvas=document.getElementById("closeCanvas"),canvasResizeHandle=document.getElementById("canvasResizeHandle"),imageScaleSlider=document.getElementById("imageScale"),imageScaleValue=document.getElementById("imageScaleValue"),addTextBtn=document.getElementById("addTextBtn"),timeDialog=document.getElementById("timeDialog"),datetimeInput=document.getElementById("datetimeInput"),closeTimeDialog=document.getElementById("closeTimeDialog"),confirmTimeBtn=document.getElementById("confirmTimeBtn"),imageWidthInput=document.getElementById("imageWidth"),imageHeightInput=document.getElementById("imageHeight"),toolPen=document.getElementById("toolPen"),toolEraser=document.getElementById("toolEraser"),toolText=document.getElementById("toolText"),toolClear=document.getElementById("toolClear"),brushSizeSlider=document.getElementById("brushSize"),fontSizeInput=document.getElementById("fontSize"),fontFamilySelect=document.getElementById("fontFamily"),textInput=document.getElementById("textInput"),drawingStatus=document.getElementById("drawingStatus"),currentToolEl=document.getElementById("currentTool"),currentSizeEl=document.getElementById("currentSize"),drawingModeIndicator=document.getElementById("drawingModeIndicator"),toggleDrawingModeBtn=document.getElementById("toggleDrawingMode"),floatToggleDrawingModeBtn=document.getElementById("floatToggleDrawingMode"),sliders={saturation:document.getElementById("saturation"),brightness:document.getElementById("brightness"),contrast:document.getElementById("contrast"),diffusion:document.getElementById("diffusion")},sliderValues={saturation:document.getElementById("saturationValue"),brightness:document.getElementById("brightnessValue"),contrast:document.getElementById("contrastValue"),diffusion:document.getElementById("diffusionValue")};function init(){canvas=previewCanvas,ctx=canvas.getContext("2d"),floatCanvas=floatPreviewCanvas,floatCtx=floatCanvas.getContext("2d"),updateCanvasSize();const e=new Date,t=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().slice(0,16);datetimeInput.value=t,canvas.addEventListener("mousedown",startDrawing),canvas.addEventListener("mousemove",draw),canvas.addEventListener("mouseup",stopDrawing),canvas.addEventListener("mouseout",stopDrawing),floatCanvas.addEventListener("mousedown",startDrawingFloat),floatCanvas.addEventListener("mousemove",drawFloat),floatCanvas.addEventListener("mouseup",stopDrawing),floatCanvas.addEventListener("mouseout",stopDrawing),canvas.addEventListener("touchstart",handleTouchStart,{passive:!1}),canvas.addEventListener("touchmove",handleTouchMove,{passive:!1}),canvas.addEventListener("touchend",handleTouchEnd),canvas.addEventListener("touchcancel",handleTouchEnd),floatCanvas.addEventListener("touchstart",handleFloatTouchStart,{passive:!1}),floatCanvas.addEventListener("touchmove",handleFloatTouchMove,{passive:!1}),floatCanvas.addEventListener("touchend",handleTouchEnd),floatCanvas.addEventListener("touchcancel",handleTouchEnd),document.addEventListener("keydown",(e=>{"Shift"===e.key&&(shiftKeyPressed=!0,sourceImage&&!isDrawingModeActive&&(canvas.style.cursor="move",floatCanvas.style.cursor="move"))})),document.addEventListener("keyup",(e=>{"Shift"===e.key&&(shiftKeyPressed=!1,updateCursorStyle())})),toggleDrawingModeBtn.addEventListener("click",toggleDrawingMode),floatToggleDrawingModeBtn.addEventListener("click",toggleDrawingMode),btnProcess.addEventListener("click",processImage),btnSend.addEventListener("click",sendimg),btnDownload.addEventListener("click",downloadImageFile),btnReset.addEventListener("click",resetProcessing),btnClearLog.addEventListener("click",clearLog),toggleCanvasFloat.addEventListener("click",toggleCanvas),closeCanvas.addEventListener("click",hideCanvas),btnSetTime.addEventListener("click",showTimeDialog),closeTimeDialog.addEventListener("click",hideTimeDialog),confirmTimeBtn.addEventListener("click",setTime),brushSizeSlider.addEventListener("input",(function(){brushSize=parseInt(this.value),currentSizeEl.textContent=brushSize}));floatingCanvasContainer.querySelector("div:first-child").addEventListener("mousedown",startDrag),document.addEventListener("mousemove",drag),document.addEventListener("mouseup",stopDrag),canvasResizeHandle.addEventListener("mousedown",startResize),document.addEventListener("mousemove",resize),document.addEventListener("mouseup",stopResize),Object.keys(sliders).forEach((e=>{sliders[e].addEventListener("input",(t=>{currentParams[e]=parseInt(t.target.value),sliderValues[e].textContent=`${currentParams[e]}%`}))})),document.getElementById("canvasSize").addEventListener("change",(function(){const e=getSelectedCanvasSize();imageWidthInput.value=e.width,imageHeightInput.value=e.height})),addLog("欢迎使用墨水屏蓝牙图片工具！"),updateButtonStatus()}function toggleDrawingMode(){isDrawingModeActive=!isDrawingModeActive,isDrawingModeActive?(toggleDrawingModeBtn.innerHTML='<i class="fa fa-stop mr-1"></i>退出绘画',toggleDrawingModeBtn.classList.remove("bg-primary"),toggleDrawingModeBtn.classList.add("bg-amber-500"),floatToggleDrawingModeBtn.innerHTML='<i class="fa fa-stop mr-1"></i>退出绘画',floatToggleDrawingModeBtn.classList.add("text-amber-300"),drawingModeIndicator.classList.remove("hidden"),addLog("已进入绘画模式，图片已锁定无法移动")):(toggleDrawingModeBtn.innerHTML='<i class="fa fa-pencil mr-1"></i>开始绘画',toggleDrawingModeBtn.classList.remove("bg-amber-500"),toggleDrawingModeBtn.classList.add("bg-primary"),floatToggleDrawingModeBtn.innerHTML='<i class="fa fa-pencil mr-1"></i>开始绘画',floatToggleDrawingModeBtn.classList.remove("text-amber-300"),drawingModeIndicator.classList.add("hidden"),addLog("已退出绘画模式，图片可以移动")),updateCursorStyle()}function updateCursorStyle(){isDrawingModeActive?"pen"===currentTool?(canvas.style.cursor="crosshair",floatCanvas.style.cursor="crosshair"):"eraser"===currentTool?(canvas.style.cursor="url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 13L5 5'/%3E%3C/svg%3E\") 0 24, auto",floatCanvas.style.cursor="url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 13L5 5'/%3E%3C/svg%3E\") 0 24, auto"):"text"===currentTool&&(canvas.style.cursor="text",floatCanvas.style.cursor="text"):shiftKeyPressed&&sourceImage?(canvas.style.cursor="move",floatCanvas.style.cursor="move"):"pen"===currentTool?(canvas.style.cursor="crosshair",floatCanvas.style.cursor="crosshair"):"eraser"===currentTool?(canvas.style.cursor="url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 13L5 5'/%3E%3C/svg%3E\") 0 24, auto",floatCanvas.style.cursor="url(\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M18 13L5 5'/%3E%3C/svg%3E\") 0 24, auto"):"text"===currentTool&&(canvas.style.cursor="text",floatCanvas.style.cursor="text")}function setDrawingTool(e){switch(currentTool=e,[toolPen,toolEraser,toolText,toolClear].forEach((e=>{e.classList.remove("active")})),e){case"pen":toolPen.classList.add("active"),currentToolEl.textContent="画笔";break;case"eraser":toolEraser.classList.add("active"),currentToolEl.textContent="橡皮擦";break;case"text":toolText.classList.add("active"),currentToolEl.textContent="文字"}currentSizeEl.textContent=brushSize,drawingStatus.classList.remove("hidden"),updateCursorStyle()}function setBrushColor(e){brushColor=e,document.getElementById("customColor").value=e,addLog(`已选择画笔颜色: ${e}`)}function getCanvasCoordinates(e,t,a=!1){const n=e.getBoundingClientRect(),o=e.width/n.width,i=e.height/n.height;let s,r;return a?(s=(t.touches[0].clientX-n.left)*o,r=(t.touches[0].clientY-n.top)*i):(s=(t.clientX-n.left)*o,r=(t.clientY-n.top)*i),{x:s,y:r}}function isPointOnImage(e,t){if(!sourceImage)return!1;const a=imageScale/100;let n=sourceImage.width*a,o=sourceImage.height*a;return imageRotation%180!=0&&([n,o]=[o,n]),e>=imageOffset.x&&e<=imageOffset.x+n&&t>=imageOffset.y&&t<=imageOffset.y+o}function startDrawing(e){startDrawingCommon(getCanvasCoordinates(canvas,e))}function startDrawingFloat(e){startDrawingCommon(getCanvasCoordinates(floatCanvas,e))}function handleTouchStart(e){if(e.preventDefault(),1!==e.touches.length)return;startDrawingCommon(getCanvasCoordinates(canvas,e,!0))}function handleFloatTouchStart(e){if(e.preventDefault(),1!==e.touches.length)return;startDrawingCommon(getCanvasCoordinates(floatCanvas,e,!0))}function startDrawingCommon(e){lastX=e.x,lastY=e.y,isDrawing=!0,!isDrawingModeActive&&sourceImage&&isPointOnImage(e.x,e.y)&&"text"!==currentTool?(isDraggingImage=!0,dragStartPos={x:e.x,y:e.y},isDrawing=!1,canvas.style.cursor="move",floatCanvas.style.cursor="move"):"text"===currentTool&&(addTextToCanvas(e.x,e.y),isDrawing=!1)}function draw(e){drawCommon(getCanvasCoordinates(canvas,e))}function drawFloat(e){drawCommon(getCanvasCoordinates(floatCanvas,e))}function handleTouchMove(e){if(e.preventDefault(),1!==e.touches.length)return;drawCommon(getCanvasCoordinates(canvas,e,!0))}function handleFloatTouchMove(e){if(e.preventDefault(),1!==e.touches.length)return;drawCommon(getCanvasCoordinates(floatCanvas,e,!0))}function drawCommon(e){if(isDraggingImage&&!isDrawingModeActive){const t=e.x-dragStartPos.x,a=e.y-dragStartPos.y;return imageOffset.x+=t,imageOffset.y+=a,dragStartPos=e,void redrawImageWithScaleAndOffset()}isDrawing&&(drawOnCanvas(lastX,lastY,e.x,e.y),lastX=e.x,lastY=e.y,syncCanvases())}function stopDrawing(){isDrawing=!1,isDraggingImage&&(isDraggingImage=!1,updateCursorStyle())}function handleTouchEnd(){stopDrawing()}function drawOnCanvas(e,t,a,n){ctx.save(),ctx.lineCap="round",ctx.lineJoin="round",ctx.lineWidth=brushSize,"pen"===currentTool?ctx.strokeStyle=brushColor:"eraser"===currentTool&&(ctx.strokeStyle="#FFFFFF",ctx.lineWidth=2*brushSize),ctx.beginPath(),ctx.moveTo(e,t),ctx.lineTo(a,n),ctx.stroke(),ctx.restore()}function addTextToCanvas(e,t){const a=textInput.value||"请输入文字",n=parseInt(fontSizeInput.value),o=fontFamilySelect.value;a.trim()&&(ctx.save(),ctx.font=`${n}px ${o}`,ctx.fillStyle=brushColor,ctx.textBaseline="top",ctx.fillText(a,e,t),ctx.restore(),syncCanvases(),addLog(`已添加文字: "${a}"`))}function addTextManually(){if(setDrawingTool("text"),textInput.value.trim()){const e=getSelectedCanvasSize();addTextToCanvas(e.width/2,e.height/2)}else addLog("请先输入要添加的文字")}function clearCanvas(){confirm("确定要清除画布内容吗？")&&(ctx.save(),ctx.fillStyle="#FFFFFF",ctx.fillRect(0,0,canvas.width,canvas.height),ctx.restore(),syncCanvases(),addLog("已清除画布内容"))}function syncCanvases(){floatCtx.clearRect(0,0,floatCanvas.width,floatCanvas.height),floatCtx.drawImage(canvas,0,0)}function changeImageScale(e){sourceImage&&(imageScale=Math.max(0,Math.min(1e3,imageScale+e)),imageScaleSlider.value=imageScale,updateImageScale())}function updateImageScale(){sourceImage&&(imageScale=parseInt(imageScaleSlider.value),imageScaleValue.textContent=`${imageScale}%`,redrawImageWithScaleAndOffset())}function redrawImageWithScaleAndOffset(){if(!sourceImage)return;ctx.fillStyle="#FFFFFF",ctx.fillRect(0,0,canvas.width,canvas.height);const e=imageScale/100;let t=sourceImage.width*e,a=sourceImage.height*e;ctx.save(),ctx.translate(imageOffset.x+t/2,imageOffset.y+a/2),ctx.rotate(imageRotation*Math.PI/180),imageRotation%180!=0&&([t,a]=[a,t]),ctx.drawImage(sourceImage,-t/2,-a/2,t,a),ctx.restore(),syncCanvases()}function fitImageToCanvas(){if(!sourceImage)return;const e=getSelectedCanvasSize();let t=e.width,a=e.height;const n=t/sourceImage.width,o=a/sourceImage.height,i=Math.min(n,o);imageScale=100*i,imageScaleSlider.value=imageScale,imageScaleValue.textContent=`${imageScale.toFixed(0)}%`,imageOffset.x=(t-sourceImage.width*i)/2,imageOffset.y=(a-sourceImage.height*i)/2,redrawImageWithScaleAndOffset(),addLog("图片已适应画布大小")}function fillCanvas(){if(!sourceImage)return;const e=getSelectedCanvasSize();let t=e.width,a=e.height;const n=t/sourceImage.width,o=a/sourceImage.height;imageScale=100*Math.max(n,o),imageScaleSlider.value=imageScale,imageScaleValue.textContent=`${imageScale.toFixed(0)}%`,imageOffset.x=0,imageOffset.y=0,redrawImageWithScaleAndOffset(),addLog("图片已铺满画布")}function centerImageOnCanvas(){if(!sourceImage)return;const e=getSelectedCanvasSize();let t=e.width,a=e.height;const n=imageScale/100;let o=sourceImage.width*n,i=sourceImage.height*n;imageRotation%180!=0&&([o,i]=[i,o]),imageOffset.x=(t-o)/2,imageOffset.y=(a-i)/2,redrawImageWithScaleAndOffset(),addLog("图片已居中显示")}function rotateImage(e){sourceImage?(imageRotation=(imageRotation+e)%360,redrawImageWithScaleAndOffset(),addLog(`图片已旋转至 ${imageRotation}°`)):addLog("请先上传图片")}function resizeImage(e,t){if(!sourceImage||!originalImage)return;originalImage.width,originalImage.height;let a=sourceImage.width+e,n=sourceImage.height+t;a=Math.max(50,a),n=Math.max(50,n),imageWidthInput.value=Math.round(a),imageHeightInput.value=Math.round(n);const o=new Image;o.onload=function(){sourceImage=o,redrawImageWithScaleAndOffset(),addLog(`图片尺寸已调整为: ${a} × ${n}`)};const i=document.createElement("canvas");i.width=a,i.height=n;i.getContext("2d").drawImage(originalImage,0,0,a,n),o.src=i.toDataURL()}function applyImageDimensions(){const e=parseInt(imageWidthInput.value),t=parseInt(imageHeightInput.value);if(isNaN(e)||isNaN(t)||e<50||t<50)addLog("请输入有效的尺寸（最小50x50像素）");else if(originalImage){const a=new Image;a.onload=function(){sourceImage=a,fitImageToCanvas(),addLog(`图像尺寸已设置为: ${e} × ${t}`)};const n=document.createElement("canvas");n.width=e,n.height=t;n.getContext("2d").drawImage(originalImage,0,0,e,t),a.src=n.toDataURL()}else addLog(`图像尺寸已设置为: ${e} × ${t}`)}function handleImageUpload(e){const t=e.target.files[0];if(!t)return;document.getElementById("fileInfo").textContent=`文件名: ${t.name} (${formatFileSize(t.size)})`,document.getElementById("fileInfo").classList.remove("hidden");const a=new FileReader;a.onload=function(e){const a=new Image;a.onload=function(){originalImage=new Image,originalImage.src=a.src,sourceImage=new Image,sourceImage.src=a.src,imageRotation=0,imageWidthInput.value=a.width,imageHeightInput.value=a.height,fitImageToCanvas(),saveOriginalCanvasState(),addLog(`已加载图片: ${t.name}`),addLog(`图片原始尺寸: ${a.width} × ${a.height}`),addLog("提示：按住Shift键拖动图片，或直接点击图片拖动"),updateCanvasVisibility()},a.src=e.target.result},a.readAsDataURL(t)}function saveOriginalCanvasState(){const e=getSelectedCanvasSize();originalCanvasData=ctx.getImageData(0,0,e.width,e.height)}function clearLog(){logContainer.innerHTML='<div class="text-gray-500 italic">操作日志将显示在这里...</div>',addLog("日志已清除")}function preConnect(){if(null!=gattServer&&gattServer.connected)null!=bleDevice&&bleDevice.gatt.connected&&(addLog(`正在断开与 ${bleDevice.name||"未知设备"} 的连接...`),bleDevice.gatt.disconnect());else{resetBluetoothVariables();try{navigator.bluetooth.requestDevice({filters:[{namePrefix:"NRF_"}],optionalServices:["32120001-0bf6-448a-9608-1b01a1a8f75c"]}).then((e=>{addLog(`已选择设备: ${e.name||"NRF设备(未知名称)"}`),bleDevice=e,bleDevice.addEventListener("gattserverdisconnected",disconnect),setTimeout((()=>connect()),300)})).catch((e=>{addLog(`蓝牙设备选择失败: ${e.message}`),"NotFoundError"===e.name&&addLog("未找到NRF前缀的蓝牙设备，请确认设备已开启")}))}catch(e){addLog(`蓝牙操作异常: ${e.message}`),addLog("请检查蓝牙是否已开启并授予权限")}}}async function connect(){if(bleDevice)if(epdCharacteristic)addLog("已经连接到设备，无需重复连接");else try{addLog(`正在连接: ${bleDevice.name||"NRF设备(未知名称)"}`),gattServer=await bleDevice.gatt.connect(),epdService=await gattServer.getPrimaryService("32120001-0bf6-448a-9608-1b01a1a8f75c"),epdCharacteristic=await epdService.getCharacteristic("32120002-0bf6-448a-9608-1b01a1a8f75c"),addLog("已成功连接到设备！"),await epdCharacteristic.startNotifications(),epdCharacteristic.addEventListener("characteristicvaluechanged",(e=>{handleNotify(e.target.value)})),await write(EpdCmd.INIT),document.getElementById("connectbutton").innerHTML='<i class="fa fa-unplug mr-1"></i>断开',updateButtonStatus()}catch(e){addLog(`连接过程出错: ${e.message}`),disconnect()}else addLog("连接失败: 未选择蓝牙设备")}function disconnect(){bleDevice&&bleDevice.gatt.connected&&bleDevice.gatt.disconnect(),resetBluetoothVariables(),addLog("已断开连接"),document.getElementById("connectbutton").innerHTML='<i class="fa fa-plug mr-1"></i>连接',updateButtonStatus()}function resetBluetoothVariables(){gattServer=null,epdService=null,epdCharacteristic=null,msgIndex=0}async function write(e,t,a=!0){if(!epdCharacteristic)return addLog("未连接蓝牙设备"),!1;let n=[e];t&&("string"==typeof t&&(t=hex2bytes(t)),t instanceof Uint8Array&&(t=Array.from(t)),n.push(...t));try{a?await epdCharacteristic.writeValueWithResponse(Uint8Array.from(n)):await epdCharacteristic.writeValueWithoutResponse(Uint8Array.from(n))}catch(e){return addLog(`发送失败: ${e.message}`),!1}return!0}async function writeImage(e,t="bw"){const a=document.getElementById("mtusize").value-2,n=document.getElementById("interleavedcount").value,o=Math.ceil(e.length/a);let i=0,s=n;getSelectedCanvasSize();for(let r=0;r<e.length;r+=a){addLog(`${"bw"==t?"黑白":"红色"}包: ${i+1}/${o}, 用时: ${(((new Date).getTime()-startTime)/1e3).toFixed(1)}s`);const d=[("bw"==t?15:0)|(0==r?0:240),...e.slice(r,r+a)];s>0?(await write(EpdCmd.WRITE_IMG,d,!1),s--):(await write(EpdCmd.WRITE_IMG,d,!0),s=n),i++}}function downloadImageFile(){if(!checkCanvasHasContent(canvas))return void addLog("请先上传或绘制图像并处理后再下载");const e=getSelectedCanvasSize(),{width:t,height:a}=getEffectiveCanvasSize(e),n=processImageData(getRotatedImageData(canvas,e,imageRotation),ditherMode.value,t,a),o=n.length,i=(o/1024).toFixed(2),s=t*a,r=n.map((e=>e.toString(16).padStart(2,"0"))).join(" "),d=new Blob([r],{type:"text/plain"}),l=URL.createObjectURL(d),c=document.createElement("a");c.href=l,c.download=`e-paper-image-${(new Date).getTime()}.txt`,document.body.appendChild(c),c.click(),setTimeout((()=>{document.body.removeChild(c),URL.revokeObjectURL(l)}),0),addLog(`图像文本文件已下载 - 数据量: ${o} 字节 (${i} KB)，像素: ${s}`)}function showTimeDialog(){if(!epdCharacteristic)return void addLog("请先连接蓝牙设备！");const e=new Date,t=new Date(e.getTime()-6e4*e.getTimezoneOffset()).toISOString().slice(0,16);datetimeInput.value=t,timeDialog.classList.remove("hidden")}function hideTimeDialog(){timeDialog.classList.add("hidden")}async function setTime(){if(!epdCharacteristic)return addLog("请先连接蓝牙设备！"),void hideTimeDialog();const e=datetimeInput.value;if(!e)return void addLog("请选择日期和时间");const t=new Date(e),a=Math.floor(t.getTime()/1e3),n=[a>>24&255,a>>16&255,a>>8&255,255&a];try{setStatus("正在设置时间..."),statusContainer.style.display="block",await write(EpdCmd.SET_TIME,n),addLog(`已设置时间: ${t.toLocaleString()}`),addLog(`时间戳: ${a} (0x${a.toString(16).toUpperCase()})`),setTimeout((()=>{statusContainer.style.display="none"}),2e3)}catch(e){addLog(`设置时间失败: ${e.message}`)}finally{hideTimeDialog()}}async function setClockMode(){if(epdCharacteristic)try{setStatus("正在切换到时钟模式..."),statusContainer.style.display="block",await write(EpdCmd.SET_MODE,[DisplayMode.CLOCK]),currentMode="clock",addLog("已切换到时钟模式"),setTimeout((()=>{statusContainer.style.display="none"}),2e3)}catch(e){addLog(`切换模式失败: ${e.message}`)}else addLog("请先连接蓝牙设备！")}async function setCalendarMode(){if(epdCharacteristic)try{setStatus("正在切换到日历模式..."),statusContainer.style.display="block",await write(EpdCmd.SET_MODE,[DisplayMode.CALENDAR]),currentMode="calendar",addLog("已切换到日历模式"),setTimeout((()=>{statusContainer.style.display="none"}),2e3)}catch(e){addLog(`切换模式失败: ${e.message}`)}else addLog("请先连接蓝牙设备！")}async function clearScreen(){if(epdCharacteristic){if(confirm("确定要清空墨水屏显示内容吗？"))try{setStatus("正在清空屏幕..."),statusContainer.style.display="block",await write(EpdCmd.CLEAR),await write(EpdCmd.REFRESH),addLog("已清空墨水屏显示内容"),setTimeout((()=>{statusContainer.style.display="none"}),2e3)}catch(e){addLog(`清空屏幕失败: ${e.message}`)}}else addLog("请先连接蓝牙设备！")}function getEffectiveCanvasSize(e){let t=e.width,a=e.height;return imageRotation%180!=0&&([t,a]=[a,t]),{width:t,height:a}}function getRotatedImageData(e,t,a){const n=document.createElement("canvas"),o=n.getContext("2d"),{width:i,height:s}=getEffectiveCanvasSize(t);return n.width=i,n.height=s,o.save(),90===a?(o.translate(i,0),o.rotate(Math.PI/2)):180===a?(o.translate(i,s),o.rotate(Math.PI)):270===a&&(o.translate(0,s),o.rotate(3*Math.PI/2)),o.drawImage(e,0,0),o.restore(),o.getImageData(0,0,i,s)}function getDitherAlgorithmName(e){return{floydSteinberg:"Floyd-Steinberg",atkinson:"Atkinson",bayer:"Bayer",stucki:"Stucki",jarvis:"Jarvis-Judice-Ninke"}[e]||e}function setDitherMode(e){ditherMode.value=e,addLog(`已选择${"blackWhiteColor"===e?"黑白":"黑白红"}模式`)}function onDitherAlgChange(e){currentParams.ditherAlg=e.target.value,addLog(`已选择${getDitherAlgorithmName(currentParams.ditherAlg)}抖动算法`)}function getSelectedCanvasSize(){const e=document.getElementById("canvasSize").value;return canvasSizes.find((t=>t.name===e))||canvasSizes[1]}let originalImageData=null;function updateCanvasSize(e=!1){const t=getSelectedCanvasSize(),a=checkCanvasHasContent(canvas);imageWidthInput.value=t.width,imageHeightInput.value=t.height,canvas.width=t.width,canvas.height=t.height,floatCanvas.width=t.width,floatCanvas.height=t.height,e&&a?originalCanvasData&&ctx.putImageData(originalCanvasData,0,0):(ctx.fillStyle="#FFFFFF",ctx.fillRect(0,0,t.width,t.height)),syncCanvases(),processedImageInfo.textContent=`${t.width} × ${t.height} 像素`,updateCanvasVisibility()}function updateDitcherOptions(){const e=document.getElementById("epddriver"),t=e.options[e.selectedIndex],a=t.getAttribute("data-color"),n=t.getAttribute("data-size");if(a&&(ditherMode.value=a),n){canvasSizes.some((e=>e.name===n))&&(document.getElementById("canvasSize").value=n)}updateCanvasSize(!0)}function processImage(){saveOriginalCanvasState(),addLog(`开始处理图片，使用${getDitherAlgorithmName(currentParams.ditherAlg)}算法...`);const e=getSelectedCanvasSize();let t=ctx.getImageData(0,0,e.width,e.height);t=adjustImageParameters(t,currentParams);const a=ditherMode.value;let n;"blackWhiteColor"===a?n=convertToBlackWhite(t,currentParams):"threeColor"===a&&(n=convertToBlackWhiteRed(t,currentParams)),ctx.putImageData(n.imageData,0,0),syncCanvases(),processedImageInfo.textContent=`${e.width} × ${e.height} 像素 (${"blackWhiteColor"===a?"黑白":"黑白红"})`,addLog("图片处理完成"),updateCanvasVisibility()}async function sendimg(){if(!epdCharacteristic)return void addLog("请先连接蓝牙设备！");document.getElementById("canvasSize").value;const e=document.getElementById("ditherMode").value,t=document.getElementById("epddriver");t.options[t.selectedIndex];startTime=(new Date).getTime(),setStatus("正在传输图片..."),statusContainer.style.display="block",addLog("开始传输原始画布数据到墨水屏...");const a=getSelectedCanvasSize(),{width:n,height:o}=getEffectiveCanvasSize(a),i=processImageData(getRotatedImageData(canvas,a,imageRotation),e,n,o);updateButtonStatus(!0);try{if(await write(EpdCmd.SET_MODE,[DisplayMode.IMAGE]),currentMode="image","threeColor"===e){const e=Math.floor(i.length/2);await writeImage(i.slice(0,e),"bw"),await writeImage(i.slice(e),"red")}else{if("blackWhiteColor"!==e)return addLog("当前设备不支持此颜色模式"),void updateButtonStatus();await writeImage(i,"bw")}await write(EpdCmd.REFRESH);const t=(((new Date).getTime()-startTime)/1e3).toFixed(2);setStatus(`传输成功！耗时 ${t} 秒`),addLog(`原始画布数据传输成功！耗时 ${t} 秒`),addLog("请等待屏幕刷新完成")}catch(e){setStatus("传输失败"),addLog(`传输失败: ${e.message}`)}finally{updateButtonStatus(!1),setTimeout((()=>{statusContainer.style.display="none"}),5e3)}}function adjustImageParameters(e,t){const a=e.data,n=t.saturation/100,o=t.brightness/100,i=t.contrast/100,s=t.diffusion/100,r=0!==i?259*(i+255)/(255*(259-i)):1,d=new Uint8ClampedArray(a);for(let t=0;t<a.length;t+=4){let i=Math.min(255,Math.max(0,d[t]*o)),l=Math.min(255,Math.max(0,d[t+1]*o)),c=Math.min(255,Math.max(0,d[t+2]*o));i=Math.min(255,Math.max(0,r*(i-128)+128)),l=Math.min(255,Math.max(0,r*(l-128)+128)),c=Math.min(255,Math.max(0,r*(c-128)+128));const g=.299*i+.587*l+.114*c;if(i=Math.min(255,Math.max(0,g+n*(i-g))),l=Math.min(255,Math.max(0,g+n*(l-g))),c=Math.min(255,Math.max(0,g+n*(c-g))),s>0){const a=e.width,n=t/4%a,o=Math.floor(t/4/a);if(n>0&&o>0){const e=t-4*(a+1);i=Math.floor(i*(1-s)+d[e]*s),l=Math.floor(l*(1-s)+d[e+1]*s),c=Math.floor(c*(1-s)+d[e+2]*s)}}a[t]=i,a[t+1]=l,a[t+2]=c}return e}function convertToBlackWhite(e,t){const a=e.width,n=e.height,o=ctx.createImageData(a,n);return o.data.set(e.data),applyDitheringAlgorithm(o,128,t),{imageData:o}}function convertToBlackWhiteRed(e,t){const a=e.width,n=e.height,o=ctx.createImageData(a,n);o.data.set(e.data);const i=o.data;for(let e=0;e<i.length;e+=4){const t=i[e],a=i[e+1],n=i[e+2];if(t>180&&a<.6*t&&n<.6*t)i[e+3]=1;else{const o=.299*t+.587*a+.114*n;i[e]=o,i[e+1]=o,i[e+2]=o,i[e+3]=0}}applyDitheringAlgorithm(o,100,t,!0);for(let e=0;e<i.length;e+=4){if(1===i[e+3])i[e]=255,i[e+1]=0,i[e+2]=0;else{const t=i[e]>100?255:0;i[e]=i[e+1]=i[e+2]=t}i[e+3]=255}return{imageData:o}}function applyDitheringAlgorithm(e,t,a,n=!1){const o=e.data,i=e.width,s=e.height,r=a.ditherAlg,d=a.diffusion/100,l=new Uint8ClampedArray(o);for(let e=0;e<s;e++)for(let a=0;a<i;a++){const c=4*(e*i+a);if(n&&1===l[c+3])continue;const g=l[c],u=g<t?0:255,m=g-u,h=1+d;switch(r){case"floydSteinberg":propagateError(l,a,e,i,s,m*h,7/16,1,0),propagateError(l,a,e,i,s,m*h,3/16,-1,1),propagateError(l,a,e,i,s,m*h,5/16,0,1),propagateError(l,a,e,i,s,m*h,1/16,1,1);break;case"atkinson":propagateError(l,a,e,i,s,m*h,1/8,1,0),propagateError(l,a,e,i,s,m*h,1/8,2,0),propagateError(l,a,e,i,s,m*h,1/8,-1,1),propagateError(l,a,e,i,s,m*h,1/8,0,1),propagateError(l,a,e,i,s,m*h,1/8,1,1),propagateError(l,a,e,i,s,m*h,1/8,0,2)}o[c]=u,o[c+1]=u,o[c+2]=u}}function propagateError(e,t,a,n,o,i,s,r,d){const l=t+r,c=a+d;if(l>=0&&l<n&&c>=0&&c<o){const t=4*(c*n+l);e[t]=Math.max(0,Math.min(255,e[t]+i*s))}}function processImageData(e,t){const a=e.width,n=e.height,o=e.data;let i;if("sixColor"===t){i=new Uint8Array(a*n);for(let e=0;e<n;e++)for(let s=0;s<a;s++){const r=4*(e*a+s),d=o[r],l=o[r+1],c=o[r+2],g=findClosestColor(d,l,c,t);i[s*n+(n-1-e)]=g.value}}else if("fourColor"===t){i=new Uint8Array(Math.ceil(a*n/4));for(let e=0;e<n;e++)for(let n=0;n<a;n++){const s=4*(e*a+n),r=o[s],d=o[s+1],l=o[s+2],c=findClosestColor(r,d,l,t).value,g=6-n%4*2;i[(e*a+n)/4|0]|=c<<g}}else if("blackWhiteColor"===t){const e=Math.ceil(a/8);i=new Uint8Array(e*n);const t=140;for(let s=0;s<n;s++)for(let n=0;n<a;n++){const r=4*(s*a+n),d=o[r],l=o[r+1],c=o[r+2],g=Math.round(.299*d+.587*l+.114*c)>=t?1:0,u=7-n%8;i[s*e+Math.floor(n/8)]|=g<<u}}else if("threeColor"===t){const e=Math.ceil(a/8),t=140,s=160,r=new Uint8Array(n*e),d=new Uint8Array(n*e);for(let i=0;i<n;i++)for(let n=0;n<a;n++){const l=4*(i*a+n),c=o[l],g=o[l+1],u=o[l+2],m=Math.round(.299*c+.587*g+.114*u)>=t?1:0,h=i*e+Math.floor(n/8),v=7-n%8;m?r[h]|=1<<v:r[h]&=~(1<<v);const f=c>s&&c>g&&c>u?0:1,C=i*e+Math.floor(n/8),E=7-n%8;f?d[C]|=1<<E:d[C]&=~(1<<E)}i=new Uint8Array(r.length+d.length),i.set(r,0),i.set(d,r.length)}return i}function toggleCanvas(){floatingCanvasContainer.classList.contains("hidden")?(floatingCanvasContainer.classList.remove("hidden"),toggleCanvasFloat.innerHTML='<i class="fa fa-compress mr-1"></i>隐藏画布',addLog("已显示浮动画布")):hideCanvas()}function hideCanvas(){floatingCanvasContainer.classList.add("hidden"),toggleCanvasFloat.innerHTML='<i class="fa fa-arrows-alt mr-1"></i>浮动画布',addLog("已隐藏浮动画布")}function updateCanvasVisibility(){checkCanvasHasContent(canvas)?(noImagePlaceholder.classList.add("hidden"),canvas.classList.remove("hidden"),floatPreviewCanvas.classList.remove("hidden")):(noImagePlaceholder.classList.remove("hidden"),canvas.classList.add("hidden"),floatPreviewCanvas.classList.add("hidden"))}function checkCanvasHasContent(e){const t=e.getContext("2d").getImageData(0,0,e.width,e.height).data;for(let e=0;e<t.length;e+=4)if(255!==t[e]||255!==t[e+1]||255!==t[e+2])return!0;return!1}function startDrag(e){isDragging=!0;const t=floatingCanvasContainer.getBoundingClientRect();dragOffset.x=e.clientX-t.left,dragOffset.y=e.clientY-t.top}function drag(e){if(!isDragging)return;e.preventDefault();const t=e.clientX-dragOffset.x,a=e.clientY-dragOffset.y,n=window.innerWidth,o=window.innerHeight,i=floatingCanvasContainer.offsetWidth,s=floatingCanvasContainer.offsetHeight,r=Math.max(0,Math.min(t,n-i)),d=Math.max(0,Math.min(a,o-s));floatingCanvasContainer.style.left=`${r}px`,floatingCanvasContainer.style.top=`${d}px`}function stopDrag(){isDragging=!1}function startResize(e){isResizing=!0,e.preventDefault()}function resize(e){if(!isResizing)return;e.preventDefault();const t=floatingCanvasContainer.getBoundingClientRect(),a=e.clientX-t.left,n=e.clientY-t.top;a>200&&n>150&&(floatingCanvasContainer.style.width=`${a}px`,floatingCanvasContainer.style.height=`${n}px`)}function stopResize(){isResizing=!1}function resetProcessing(){if(originalCanvasData){ctx.putImageData(originalCanvasData,0,0),syncCanvases();const e=getSelectedCanvasSize();processedImageInfo.textContent=`${e.width} × ${e.height} 像素`,addLog("已重置处理效果，保留原始图片和设置")}else ctx.fillStyle="#FFFFFF",ctx.fillRect(0,0,canvas.width,canvas.height),syncCanvases(),addLog("已清空画布，保留设置和图片")}function addLog(e){const t=(new Date).toLocaleTimeString(),a=document.createElement("div");for(a.className="mb-1 border-b border-gray-100 pb-1 last:border-0 last:mb-0 last:pb-0",a.innerHTML=`<span class="text-gray-500">[${t}]</span> <span class="text-gray-800">${e}</span>`,logContainer.querySelector(".italic")&&(logContainer.innerHTML=""),logContainer.appendChild(a),logContainer.scrollTop=logContainer.scrollHeight;logContainer.childNodes.length>30;)logContainer.removeChild(logContainer.firstChild)}function setStatus(e){document.getElementById("status").textContent=e}function updateButtonStatus(e=!1){const t=null!=gattServer&&gattServer.connected,a=e||!t;btnSend.disabled=a,btnSetTime.disabled=a,a?(btnSend.classList.add("opacity-50","cursor-not-allowed"),btnSetTime.classList.add("opacity-50","cursor-not-allowed")):(btnSend.classList.remove("opacity-50","cursor-not-allowed"),btnSetTime.classList.remove("opacity-50","cursor-not-allowed"))}function reConnect(){addLog("尝试重新连接设备..."),preConnect()}function handleNotify(e){console.log("收到通知:",e)}function hex2bytes(e){const t=[];for(let a=0;a<e.length;a+=2)t.push(parseInt(e.substr(a,2),16));return t}function formatFileSize(e){return e<1024?e+" B":e<1048576?(e/1024).toFixed(2)+" KB":(e/1048576).toFixed(2)+" MB"}async function set_EPD_CMD_J_H(){await write(EpdCmd.EPD_CMD_J_H,document.getElementById("epdpins").value)}async function set_EPD_CMD_N_Z(){const e=document.getElementById("N_Z_hour").value,t=document.getElementById("N_Z_min").value,a=document.getElementById("N_Z_start").value,n=[4];n[0]=0,n[1]=0,n[2]=e,n[3]=t,n[4]=a,await write(EpdCmd.EPD_CMD_N_Z,n)}async function set_EPD_CMD_D_S(){const e=document.getElementById("D_S_hour").value,t=document.getElementById("D_S_min").value,a=document.getElementById("D_S_start").value,n=[4];n[0]=0,n[1]=0,n[2]=e,n[3]=t,n[4]=a,await write(EpdCmd.EPD_CMD_D_S,n)}async function set_EPD_CMD_J_S(){const e=document.getElementById("J_S_hour").value,t=document.getElementById("J_S_min").value,a=document.getElementById("J_S_start").value,n=[4];n[0]=0,n[1]=0,n[2]=e,n[3]=t,n[4]=a,await write(EpdCmd.EPD_CMD_J_S,n)}async function set_EPD_CMD_LED(){const e=document.getElementById("color_led").value,t=document.getElementById("liang_time").value,a=document.getElementById("liang_add").value,n=document.getElementById("liangdu").value,o=document.getElementById("liang_s").value,i=[5];i[0]=e,i[1]=t,i[2]=a,i[3]=n,i[4]=o,await write(EpdCmd.EPD_CMD_LED,i)}async function set_EPD_CMD_LED1(){const e=document.getElementById("color_led").value,t=document.getElementById("liang_time").value,a=document.getElementById("liang_add").value,n=document.getElementById("liangdu").value,o=document.getElementById("liang_s").value,i=[5];i[0]=e,i[1]=t,i[2]=a,i[3]=n,i[4]=o,await write(EpdCmd.EPD_CMD_4_LED,i)}async function set_EPD_CMD_MY(){const e=document.getElementById("fanxian").value,t=document.getElementById("xuanzhuan").value,a=document.getElementById("qiangzhi_shuaxing").value,n=document.getElementById("jushua_time").value,o=[4];o[0]=e,o[1]=t,o[2]=a,o[3]=n,await write(EpdCmd.EPD_CMD_MY,o)}async function set_EPD_CMD_COLOR(){const e=document.getElementById("color_1").value,t=document.getElementById("time_color").value,a=document.getElementById("wendu_color").value,n=document.getElementById("gongli_color").value,o=document.getElementById("shichen_color").value,i=document.getElementById("jieqi_color").value,s=document.getElementById("r_jushua_time").value,r=[7];r[0]=e,r[1]=t,r[2]=a,r[3]=n,r[4]=o,r[5]=i,r[6]=s,await write(EpdCmd.EPD_CMD_COLOR,r)}async function set_EPD_CMD_4_MS(){const e=document.getElementById("fanxian1").value,t=document.getElementById("xuanzhuan1").value,a=document.getElementById("jushua_time1").value,n=document.getElementById("xianshi_peizhi").value,o=document.getElementById("moshi_id").value,i=document.getElementById("color_11").value,s=document.getElementById("silian_ziti").value,r=[7];r[0]=e,r[1]=t,r[2]=a,r[3]=n,r[4]=o,r[5]=i,r[6]=s,await write(EpdCmd.EPD_CMD_4_MS,r)}async function syncTime(e){const t=(new Date).getTime()/1e3,a=new Uint8Array([t>>24&255,t>>16&255,t>>8&255,255&t,-(new Date).getTimezoneOffset()/60,e]);await write(EpdCmd.SET_TIME,a)&&addLog("已同步时间！")}async function set_EPD_CMD_4_ZF(e){const t=[1];t[0]=e,await write(EpdCmd.EPD_CMD_4_ZF,t),0==e&&(syncTime(2),addLog("主机已同步时间！"))}window.onload=init;
